# raw HTML → ノート＆色鉛筆風レイアウト変換手順書

## 目的

`０２rawHTMLからHugoコンテンツ変換.md` で公開した raw HTML を、
広告・スクリプトを除去し、ノート風＋色鉛筆調のオリジナルデザインに変換する。

---

## 前提

- `static/{game_slug}/` に raw HTML が配置済み（`０２` の手順完了）
- raw HTML は元サイトのまま（広告・スクリプト含む）
- 変換後も `static/{game_slug}/` に上書き保存する

---

## ステップ1: 広告・スクリプト除去

raw HTML から不要な要素を除去する。**コンテンツ本体には手を付けない。**

### 除去対象

```python
from bs4 import BeautifulSoup
import re

def clean_html(html_text):
    soup = BeautifulSoup(html_text, "html.parser")

    # 1. script / noscript
    for tag in soup.find_all(["script", "noscript"]):
        tag.decompose()

    # 2. 広告ラッパー
    for el in soup.find_all(class_="ad-wrapper"):
        el.decompose()

    # 3. 広告系div (class名に ad- または ad_ を含む)
    for el in soup.find_all("div", class_=re.compile(r"ad[-_]")):
        el.decompose()

    # 4. Google GPT広告
    for el in soup.find_all("div", id=re.compile(r"^div-gpt")):
        el.decompose()

    # 5. トラッキングリンク
    for el in soup.find_all("a", class_="track_mario"):
        el.decompose()
    for el in soup.find_all("a", class_="premium-plan-link"):
        el.decompose()

    # 6. video要素 → 静的プレースホルダーに置換
    for video in soup.find_all("video"):
        placeholder = soup.new_tag("div")
        placeholder.string = "動画コンテンツ"
        placeholder["class"] = ["video-placeholder"]
        video.replace_with(placeholder)

    # 7. インラインスクリプト属性
    for tag in soup.find_all(True):
        for attr in list(tag.attrs):
            if attr.startswith("on"):  # onclick, onload 等
                del tag[attr]

    return str(soup)
```

### 禁止名称の除去（同時実行）

```python
FORBIDDEN = ["Game8", "game8", "GameWith", "gamewith", "Altema", "altema",
             "ゲームエイト", "ゲーム8", "ゲームウィズ", "アルテマ", "攻略班"]

def remove_forbidden(html):
    # 外部サイトURL除去
    html = re.sub(r'https?://[a-z.]*game8\.jp[^\s"\'<>]*', '', html)
    html = re.sub(r'https?://img\.game8\.jp[^\s"\'<>]*', '', html)
    html = re.sub(r'https?://[a-z.]*gamewith[^\s"\'<>]*', '', html)
    html = re.sub(r'https?://[a-z.]*altema[^\s"\'<>]*', '', html)
    # 禁止ワード除去
    for w in FORBIDDEN:
        html = html.replace(w, "")
    return html
```

---

## ステップ2: 独自CSSの注入

元サイトのCSS参照を削除し、自前の色鉛筆風CSSに差し替える。

### 2-1. 元CSSの除去

```python
def replace_css(soup):
    # 元サイトのCSS linkタグを全て除去
    for link in soup.find_all("link", rel="stylesheet"):
        link.decompose()

    # 元サイトの <style> タグも除去
    for style in soup.find_all("style"):
        style.decompose()
```

### 2-2. 独自CSSの挿入

`<head>` に以下を追加:

```html
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css">
```

`/css/style.css` が色鉛筆風デザインの全スタイルを担当する。

---

## ステップ3: 色鉛筆風CSSの設計

既存の `static/css/style.css` が以下のデザインシステムを定義済み。

### 配色（色鉛筆6色）

| 変数 | 色 | 用途 |
|------|-----|------|
| `--pencil-red` | `#c75146` | h2見出し |
| `--pencil-blue` | `#4a7da8` | h3見出し・リンク |
| `--pencil-green` | `#5a8a5c` | h4見出し |
| `--pencil-yellow` | `#d4a745` | アクセント・サイドバー |
| `--pencil-brown` | `#8a6d4a` | テーブル枠・ボーダー |
| `--pencil-gray` | `#8a7e70` | 副テキスト |

### フォント

```css
font-family: "Klee One", "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
```

「Klee One」は手書き風の日本語フォント（Google Fonts提供）。

### ノート風背景（罫線グリッド）

```css
body {
  background-color: var(--bg-base);  /* #f5f0e8 クリーム紙 */
  background-image:
    /* 横罫線（28pxごと） */
    repeating-linear-gradient(
      0deg, transparent, transparent 28px,
      rgba(180,170,155,.12) 28px, rgba(180,170,155,.12) 29px
    ),
    /* 縦罫線（薄く） */
    repeating-linear-gradient(
      90deg, transparent, transparent 28px,
      rgba(180,170,155,.06) 28px, rgba(180,170,155,.06) 29px
    );
}
```

### 見出し（色鉛筆下線風）

```css
h2, .a-header--2 {
  color: var(--pencil-red);
  border-left: 4px solid var(--pencil-red);
  background: linear-gradient(90deg, rgba(199,81,70,.06), transparent);
  padding: 8px 12px;
}

h3, .a-header--3 {
  color: var(--pencil-blue);
  border-bottom: 2px solid var(--pencil-blue);
}

h4, .a-header--4 {
  color: var(--pencil-green);
  border-left: 3px solid var(--pencil-green);
}
```

### テーブル（手書き風ボーダー）

```css
table, .a-table {
  border: 2px solid var(--pencil-brown);
  box-shadow: var(--shadow-md);  /* 2px 3px 0 のずれ影 */
}

th {
  background: var(--table-header-bg);
  border-bottom: 3px solid var(--pencil-brown);
}
```

### 影（手描きスケッチ風）

```css
--shadow-sm: 1px 2px 0 rgba(58,50,38,.08);
--shadow-md: 2px 3px 0 rgba(58,50,38,.1);
--shadow-lg: 3px 5px 0 rgba(58,50,38,.12);
```

blur なしの角度ずれ影で「手描きの下に落ちる影」を表現。

### ダークモード

```css
[data-theme="dark"] {
  --bg-base: #2a2520;       /* 濃い茶色の紙 */
  --bg-primary: #342e28;
  --pencil-red: #d4685e;    /* 少し明るく */
  --link-color: #7aa8c8;
}
```

---

## ステップ4: 元サイトCSSクラスの互換マッピング

raw HTML には元サイト固有のCSSクラスが残っている。
これらを独自CSSで再定義することで、HTMLを変更せずにデザインを適用できる。

### 主要クラスの対応

| 元クラス | 要素 | 独自CSSでの再定義 |
|---------|------|-------------------|
| `.a-header--2` | h2相当の見出し | 色鉛筆赤 + 左ボーダー |
| `.a-header--3` | h3相当の見出し | 色鉛筆青 + 下ボーダー |
| `.a-header--4` | h4相当の見出し | 色鉛筆緑 + 左ボーダー |
| `.a-table` | テーブル | 色鉛筆茶ボーダー + 影 |
| `.a-paragraph` | 本文段落 | 標準テキストスタイル |
| `.a-img` | 画像 | max-width + 影 |
| `.a-accordion` | 折りたたみ | 色鉛筆茶ボーダー |
| `.a-tabContainer` | タブ | ノート風タブUI |
| `.a-footnote` | 注釈 | 小さめ + 色鉛筆灰 |
| `.archive-style-wrapper` | 記事本体 | メインコンテンツ幅 |

この互換CSSは `static/css/style.css` の後半に定義済み。

---

## ステップ5: 画像の処理

### テーブル内アイコン（小さい画像 ≤ 200px）

そのまま残す。元サイトCDNから読み込まれる。
将来的にGemini APIで色鉛筆風に変換し、ローカルに差し替える。

### 大きい画像（ステージ画像等 > 200px）

黒プレースホルダーに差し替え:

```python
def replace_large_images(soup):
    for img in soup.find_all("img"):
        width = int(img.get("width", 0) or 0)
        if width > 200 or "original" in img.get("src", ""):
            img["src"] = f"/images/games/splatoon3/placeholders/black-440x248.png"
            img["loading"] = "lazy"
```

### Gemini APIでアイコンを色鉛筆風に変換（オプション）

```bash
python3 scripts/gemini_pencil_redraw.py static/images/games/splatoon3/weapons/
```

Gemini `gemini-2.5-flash-image` モデルが各アイコンを3色色鉛筆風に描き直す。
出力: `{入力ディレクトリ}/gemini_pencil/` に保存される。

---

## ステップ6: バッチ変換スクリプト

全HTMLファイルに対してステップ1〜5を一括適用する。

```python
#!/usr/bin/env python3
"""static/{game_slug}/内の全HTMLを色鉛筆風に変換"""
import os, re
from pathlib import Path
from bs4 import BeautifulSoup

GAME_SLUG = "splatoon3"
HTML_DIR = Path(f"static/{GAME_SLUG}")

FORBIDDEN = ["Game8", "game8", "GameWith", "gamewith", "Altema", "altema",
             "ゲームエイト", "ゲーム8", "ゲームウィズ", "アルテマ", "攻略班"]

def process_file(filepath):
    with open(filepath, "r", encoding="utf-8") as f:
        html = f.read()

    soup = BeautifulSoup(html, "html.parser")

    # --- 除去 ---
    for tag in soup.find_all(["script", "noscript"]):
        tag.decompose()
    for el in soup.find_all(class_="ad-wrapper"):
        el.decompose()
    for el in soup.find_all("div", class_=re.compile(r"ad[-_]")):
        el.decompose()
    for el in soup.find_all("div", id=re.compile(r"^div-gpt")):
        el.decompose()
    for el in soup.find_all("a", class_="track_mario"):
        el.decompose()
    for el in soup.find_all("a", class_="premium-plan-link"):
        el.decompose()
    for tag in soup.find_all(True):
        for attr in list(tag.attrs):
            if attr.startswith("on"):
                del tag[attr]

    # --- CSS差し替え ---
    for link in soup.find_all("link", rel="stylesheet"):
        link.decompose()
    for style in soup.find_all("style"):
        style.decompose()

    head = soup.find("head")
    if head:
        css_tag = soup.new_tag("link", rel="stylesheet", href="/css/style.css")
        font_tag = soup.new_tag("link", rel="stylesheet",
            href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap")
        head.append(font_tag)
        head.append(css_tag)

    # --- 禁止名称除去 ---
    result = str(soup)
    result = re.sub(r'https?://[a-z.]*game8\.jp[^\s"\'<>]*', '', result)
    result = re.sub(r'https?://img\.game8\.jp[^\s"\'<>]*', '', result)
    result = re.sub(r'https?://[a-z.]*gamewith[^\s"\'<>]*', '', result)
    result = re.sub(r'https?://[a-z.]*altema[^\s"\'<>]*', '', result)
    for w in FORBIDDEN:
        result = result.replace(w, "")

    with open(filepath, "w", encoding="utf-8") as f:
        f.write(result)

def main():
    files = sorted(HTML_DIR.glob("*.html"))
    print(f"対象: {len(files)}件")

    for i, fp in enumerate(files, 1):
        process_file(fp)
        if i % 100 == 0:
            print(f"  {i}/{len(files)} 完了")

    print(f"全{len(files)}件の変換完了")

if __name__ == "__main__":
    main()
```

```bash
python3 convert_to_pencil_style.py
```

---

## ステップ7: 検証

### 禁止名称チェック

```bash
grep -ri "game8\|gamewith\|altema\|ゲームエイト\|攻略班" static/splatoon3/ | head -20
# → 0件であること
```

### スクリプト残留チェック

```bash
grep -ri "<script" static/splatoon3/ | wc -l
# → 0件であること
```

### 広告残留チェック

```bash
grep -ri "ad-wrapper\|div-gpt\|track_mario" static/splatoon3/ | wc -l
# → 0件であること
```

### ブラウザ表示確認

```bash
hugo server -D
# → http://localhost:1313/splatoon3/ でノート風デザインが適用されているか確認
```

確認ポイント:
- 背景がクリーム色の罫線入りノート風になっているか
- 見出しが色鉛筆の赤・青・緑で表示されているか
- テーブルに茶色のボーダーと影が付いているか
- フォントが手書き風（Klee One）になっているか
- 広告・スクリプトが完全に除去されているか

---

## ディレクトリ構成

```
gamers-for/
├── static/
│   ├── css/
│   │   └── style.css              ← 色鉛筆風CSS（全デザイン定義）
│   └── splatoon3/
│       ├── index.html             ← 変換済みHTML
│       ├── top.html
│       ├── 478553.html
│       └── ... (1,515件)
├── scripts/
│   ├── gemini_pencil_redraw.py    ← アイコン色鉛筆変換（Gemini API）
│   └── convert_to_pencil_style.py ← バッチ変換スクリプト
└── ０００００テンプレ/
    └── ０３レイアウトをノートと色鉛筆調にする.md  ← この手順書
```

---

## 他ゲームへの展開

同じスクリプトの `GAME_SLUG` を変えるだけ。

```bash
# genshinの場合
GAME_SLUG=genshin python3 convert_to_pencil_style.py
```

CSSは `/css/style.css` 1つで全ゲーム共通。
元サイトのCSSクラス（`.a-header--2` 等）が互換定義されているため、
ゲームごとにHTMLの構造が変わっても同じデザインが適用される。

---

## 注意事項

1. **HTMLの構造（タグ・クラス名）は変更しない** — CSSで見た目だけ変える
2. **テーブル内アイコンは残す** — 小さい画像はそのまま
3. **禁止名称の除去は最終工程** — CSS差し替え後に実行
4. **元HTMLのバックアップは `raw_html/` に残っている** — `static/` は上書きOK
