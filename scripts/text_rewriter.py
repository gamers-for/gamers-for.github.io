#!/usr/bin/env python3
"""
text_rewriter.py
=================
Game8テキストを本格的にリライトするモジュール。
語尾変換ではなく、同じ情報を別の言い回し・構成で表現する。

リライト戦略:
1. 定型文のファジーマッチ → 手書きの代替表現に丸ごと置換
2. 文節レベルの再構成（節の並び替え・結合方法の変更）
3. 5文字以上のフレーズ単位での同義語置換
4. 文末のカジュアル化＋多様化
"""

import re
import hashlib


def _hash_seed(weapon_name, section=""):
    """武器名とセクションからハッシュシード値を生成（一貫したランダム選択用）"""
    key = f"{weapon_name}_{section}"
    h = hashlib.md5(key.encode()).hexdigest()
    return int(h[:8], 16)


def _pick(alternatives, weapon_name, context=""):
    """代替候補からハッシュベースで一貫した選択"""
    seed = _hash_seed(weapon_name, context)
    return alternatives[seed % len(alternatives)]


# ═══════════════════════════════════════════════════════════
# 1. 定型文の丸ごと置換辞書（ファジーマッチ対応）
# ═══════════════════════════════════════════════════════════
# キー: Game8で頻出する定型文（部分一致でもマッチ）
# 値: 完全に異なる表現の代替候補リスト

STOCK_PHRASES = [
    # --- イカダッシュ速度アップ / 機動力系 ---
    {
        "patterns": [
            "前線で接敵する際や前線から引く際などに生きるギア",
            "前線で接敵する際に生きるギア",
            "接敵する際や.*引く際.*生きる",
        ],
        "replacements": [
            "攻めるとき・退くときの両方で足の速さがモノを言うから、付けて損なし",
            "敵に仕掛けるスピードも逃げ足も上がるので、どんな場面でも頼れる",
            "接近戦を挑むときもピンチの離脱でも恩恵があり、万能に使えるギアパワー",
        ],
    },
    {
        "patterns": [
            "前線武器や短射程武器御用達の万能なギアのためおすすめ",
            "前線武器御用達の万能なギアなためおすすめ",
            "前線武器.*御用達.*おすすめ",
        ],
        "replacements": [
            "前に出るブキなら必須レベルで採用したい一品",
            "短射程・前衛タイプのブキとの相性はバツグンで、積んでおきたい",
            "前線ブキであればあるほど恩恵が大きいので、最優先枠に入れよう",
        ],
    },
    {
        "patterns": [
            "撃ち合いにおける動きやすさ、生存力を上げてくれます",
            "撃ち合いにおける動きやすさ.*上げてくれ",
            "動きやすさ.*生存力.*上げて",
        ],
        "replacements": [
            "対面のフットワークが軽くなり、デスしにくさが大幅アップ",
            "撃ち合い中に素早く動けるようになるから、相手に照準を合わせにくくさせられる",
            "接戦での回避性能が上がって、結果的にやられにくくなる",
        ],
    },
    # --- 相手インク影響軽減 ---
    {
        "patterns": [
            "相手インクに足を取られにくくなり、前線で立ち回りやすくなります",
            "相手インクに足を取られにくくなり.*立ち回り",
            "相手インク.*足.*取られにくく",
        ],
        "replacements": [
            "敵の塗りを踏んでもダメージや速度低下が軽くなり、最前線でも安定する",
            "敵インク上でのスリップダメージ＆減速を大きく軽減できる",
            "相手の塗った地面でも行動ペナルティが減るので、前衛がグッと楽になる",
        ],
    },
    {
        "patterns": [
            "しっかり効果を得るには0.3がおすすめ",
            "効果.*得る.*0.3.*おすすめ",
        ],
        "replacements": [
            "しっかり恩恵を受けるなら0.3分のスロットを確保しよう",
            "0.3ぶん装備しておくと安定感が違ってくる",
            "0.3積みが最も効率の良いラインだ",
        ],
    },
    # --- 復活時間短縮 ---
    {
        "patterns": [
            "素早く安全に前線復帰しやすくなる、前線武器御用達のギア",
            "素早く安全に前線復帰しやすくなる.*ギア",
        ],
        "replacements": [
            "デスしても素早く戦線に復帰できるので、人数不利が長引かない。前衛ブキの必需品",
            "リスポーンの回転が上がるから、倒されても試合のテンポを落とさずに済む",
            "やられた後の復帰が爆速になり、何度でもすぐに前線へ戻れる頼もしいギアパワー",
        ],
    },
    {
        "patterns": [
            "前線復帰が早くなります.*また.*離脱する際にも効果を発揮し.*生存力を上げてくれる",
            "前線復帰が早く.*離脱.*効果.*生存力",
        ],
        "replacements": [
            "復帰スピードが上がるだけでなく、囲まれたときの逃げ足にも効いて、トータルの生き残り力がアップ",
            "戦線に戻るまでの時間短縮＋ピンチ時の離脱補助で、二重に生存率を高められる",
            "リスポーン高速化と緊急離脱力の底上げ、両方のメリットを得られるのが優秀",
        ],
    },
    # --- スペシャル減少量ダウン ---
    {
        "patterns": [
            "倒された際のスペシャル減少量を減らすことで、不利な状況を打開.*しやすくなります",
            "スペシャル減少量を減らす.*打開.*しやすく",
        ],
        "replacements": [
            "やられてもゲージの減りが少ないから、劣勢でもスペシャルで巻き返すチャンスを維持できる",
            "デス時のスペシャルロスを抑えることで、苦しい展開でも逆転の切り札を温存しやすい",
            "倒されたときのゲージ減少が緩やかになり、押し込まれた場面でもスペシャルで打ち返しやすい",
        ],
    },
    # --- カムバック ---
    {
        "patterns": [
            "倒された後しばらくの間、移動速度やインク効率が良くなり.*スペシャルが溜まりやすくなります",
            "倒された後.*移動速度.*インク効率.*スペシャル.*溜まりやすく",
        ],
        "replacements": [
            "デス後に一定時間ステータスが強化されるので、復帰してすぐ全力で動ける。巻き返し性能が高い",
            "やられた後しばらく足回りとインク燃費にブーストがかかり、スペシャルも速く溜まるようになる",
            "復帰直後に移動・インク・スペシャル回転が一時的に上がるので、素早いリカバリーが可能",
        ],
    },
    {
        "patterns": [
            "不利な状況を打開しやすくなるのが強み",
            "不利な状況を打開.*強み",
        ],
        "replacements": [
            "劣勢から巻き返すきっかけを作りやすいのがメリット",
            "押されている場面でも状況を覆しやすくなるのがポイント",
            "ピンチの場面ほど真価を発揮するギアパワー",
        ],
    },
    # --- ステルスジャンプ ---
    {
        "patterns": [
            "素早く安全に前線復帰しやすくなる",
        ],
        "replacements": [
            "味方のそばへジャンプするとき着地点が見えにくくなり、安全に前線へ合流できる",
            "スーパージャンプ先のマーカーが相手に見えにくくなるから、復帰時に狙われるリスクが激減",
            "ジャンプ復帰がバレにくくなるので、前線へ安心して飛んでいける",
        ],
    },
    # --- スペシャル増加量アップ ---
    {
        "patterns": [
            "スペシャルの回転率を上げることで.*キルチャンスや打開の機会が増えます",
            "回転率.*上げる.*キルチャンス.*打開.*機会",
            "スペシャルの回転率が上がる",
        ],
        "replacements": [
            "ゲージが溜まるペースが速くなるので、1試合で使える回数がアップ。攻めにも守りにも効く",
            "スペシャルの発動頻度が増えて、キルや打開で活躍する場面が多くなる",
            "スペシャルがどんどん溜まるようになるから、チャンスの数自体を増やせるのが強い",
        ],
    },
    # --- インク効率アップ（メイン） ---
    {
        "patterns": [
            "メインウェポンのインク消費を抑えることで.*継戦能力が上がります",
            "インク消費を抑える.*継戦",
        ],
        "replacements": [
            "メインの燃費が良くなるので、インク切れで撃ち合い負けする場面が減る",
            "メイン射撃のインク消費が減って、長時間戦い続ける力がアップ",
            "インクの持ちが良くなるから、継続的に撃ち続けられて前線維持に貢献できる",
        ],
    },
    # --- アクション強化 ---
    {
        "patterns": [
            "ジャンプ撃ちの弾ブレを軽減し.*命中率が上がります",
            "ジャンプ撃ち.*弾ブレ.*軽減.*命中率",
        ],
        "replacements": [
            "空中射撃の精度がアップして、ジャンプ撃ちでの削り・キルが安定する",
            "ジャンプ中のブレが小さくなるから、イカロール後やジャンプ撃ちの命中率がグッと上がる",
            "空中からの射撃がブレにくくなるので、対面でジャンプを交えたアグレッシブな撃ち合いが強くなる",
        ],
    },
    # --- ヒト移動速度アップ ---
    {
        "patterns": [
            "射撃中の移動速度が上がるため.*対面で有利に立ち回れるようになります",
            "射撃中.*移動速度.*上がる.*対面.*有利",
        ],
        "replacements": [
            "撃ちながらの移動が速くなるから、相手の弾を避けつつ攻撃できるようになる",
            "メインを撃ちながら動くスピードがアップし、撃ち合い中のポジショニングが有利になる",
            "射撃時のヒト速が上がることで対面の回避力が強化され、撃ち勝ちやすくなる",
        ],
    },
    # --- 対物攻撃力アップ ---
    {
        "patterns": [
            "相手のスプラッシュシールドやグレートバリアなどのオブジェクトを素早く壊せるようになります",
            "オブジェクト.*素早く壊せる",
        ],
        "replacements": [
            "敵のシールドやバリアなどのオブジェクトへのダメージが増え、素早く排除できるようになる",
            "相手が設置したシールド・バリア類をサクサク破壊できるので、防御戦術に対抗しやすい",
            "敵のオブジェクト（シールド・バリア等）を効率よく壊せて、障害物に阻まれるストレスが激減",
        ],
    },
    # --- サブ性能アップ ---
    {
        "patterns": [
            "サブウェポンの性能が上がり、立ち回りの幅が広がります",
            "サブ.*性能.*上がり.*幅.*広がり",
        ],
        "replacements": [
            "サブの性能強化によって戦術の幅がぐっと広がる",
            "サブウェポンがパワーアップするので、メインだけじゃ対応しきれない場面もカバーできる",
            "サブの強化で立ち回りの選択肢が増えるのが大きい",
        ],
    },
    # --- 同名武器テンプレ ---
    {
        "patterns": [
            "同名武器は.*サブとスペシャルにのみ違いがあります.*射程や威力に変わりはない.*使う方を決め",
            "同名武器.*サブとスペシャル.*のみ違い",
        ],
        "replacements": [
            "名前が同じバリエーション武器はサブ・スペシャルだけが異なり、メインの射程やダメージは共通。ルールや好みで使い分けよう",
            "同名のブキ違いはサブとスペシャルのみ変更で、メイン性能は同一。自分のプレイスタイルやルールに合った方を選ぼう",
            "亜種ブキはサブ・スペシャルだけが別物で、メインのスペックは一緒。マッチするルールやサブスペの好みで選べばOK",
        ],
    },
]

# ═══════════════════════════════════════════════════════════
# 2. 文節・フレーズ単位の置換辞書（長いフレーズ優先）
# ═══════════════════════════════════════════════════════════
# 5文字以上のフレーズを丸ごと別表現に置換
# ※ 長いものから先にマッチさせること

PHRASE_REPLACEMENTS = [
    # --- 20文字以上 ---
    ("前線武器の強みを生かすために、ガンガン攻める際のリスク軽減になります", [
        "前衛としてガンガン突っ込む際の保険になり、攻めのリスクを下げられる",
        "積極的に前に出る立ち回りのリスクヘッジとして効果的",
        "アグレッシブに攻めるときの保険として非常に優秀",
    ]),
    ("相手に囲まれた際に前線離脱しやすく、復帰も早められます", [
        "包囲されたときに素早く抜け出せて、戦線復帰もスムーズになる",
        "敵に囲まれてもスムーズに離脱でき、リスポーン後の復帰も高速化",
        "ピンチの脱出＋素早い復帰のダブル効果で、前線の維持力が上がる",
    ]),
    ("相手に囲まれ、前線から離脱する際にも効果を発揮し", [
        "包囲されたときの緊急離脱にも効き",
        "敵に囲まれてピンチのときにも力を発揮して",
        "囲まれた際の脱出でも恩恵があり",
    ]),
    ("前線で立ち回りやすくなります", [
        "前衛での動きが安定する",
        "最前線でも余裕を持って立ち回れる",
        "前線維持がグッと楽になる",
    ]),
    ("前線付近で立ち回りやすくなり", [
        "前衛エリアでの動きが良くなり",
        "最前線でも安定して立ち回れるようになり",
        "前線周辺の立ち回りがスムーズになり",
    ]),

    # --- 15文字以上 ---
    ("前線復帰が早くなります", [
        "戦線への復帰スピードがアップ",
        "リスポーン後の復帰が高速化",
        "やられた後すぐ前線に戻れるようになる",
    ]),
    ("生存力を上げてくれる", [
        "やられにくさをアップしてくれる",
        "生き残り力を底上げする",
        "サバイバル性能を高める",
    ]),
    ("スペシャルが溜まりやすくなります", [
        "ゲージの溜まりが速くなる",
        "スペシャルの回転が良くなる",
        "スペシャルのチャージが加速する",
    ]),
    ("ガンガン攻める際のリスク軽減になります", [
        "攻めの姿勢を取るときのリスクヘッジになる",
        "アグレッシブに前に出るときの保険になる",
        "積極的に仕掛けるときのリスクを抑えられる",
    ]),
    ("一方的に倒すことができます", [
        "安全に倒せる",
        "ワンサイドで倒しきれる",
        "リスクなくキルを取れる",
    ]),
    ("射程差を生かして", [
        "リーチ差を活かして",
        "射程の優位を使って",
        "長い射程で一方的に",
    ]),
    ("けん制や塗りをしながら", [
        "牽制と塗り広げを並行しつつ",
        "けん制＆塗りで場を整えながら",
        "塗りつつ相手をけん制して",
    ]),
    ("味方のカバーをしながら", [
        "味方のフォローを入れつつ",
        "仲間をサポートしながら",
        "味方をバックアップしつつ",
    ]),
    ("立ち回りメインで", [
        "プレイスタイルが中心で",
        "動き方がベースで",
        "戦い方を軸にして",
    ]),

    # --- 10文字以上 ---
    ("キルを取るといった", [
        "敵を倒していく", "キルを狙う",
    ]),
    ("キルを取ることができる", [
        "敵を仕留められる", "倒しきれる", "キル回収ができる",
    ]),
    ("キルが取りやすい", [
        "キルを拾いやすい", "倒しやすい", "キル性能が高い",
    ]),
    ("キルが取れそうなとき", [
        "チャンスが来たとき", "倒せそうなタイミングで", "キルチャンスが見えたら",
    ]),
    ("使ってけん制", [
        "活用して牽制", "投げてけん制", "当ててけん制",
    ]),
    ("前に出ることができます", [
        "前に出られる", "前線を押し上げられる", "アグレッシブに攻められる",
    ]),
    ("インク効率が良くなり", [
        "インクの燃費が改善して", "インク持ちが良くなり", "インク消費を抑えられて",
    ]),
    ("塗りを広げることができる", [
        "塗り範囲を広げられる", "塗りを展開できる", "効率よく塗れる",
    ]),
    ("立ち回りやすくなる", [
        "動きやすくなる", "戦いやすくなる", "プレイしやすくなる",
    ]),
    ("相性が良い", [
        "かみ合いが良い", "好相性", "マッチする",
    ]),
    ("相性が良く", [
        "かみ合いが良く", "好相性で", "マッチして",
    ]),
    ("積むことで", [
        "装備すると", "付けることで", "積めば",
    ]),
    ("ことで", [  # shorter version - only apply if longer didn't match
        "ことにより", "と", "おかげで",
    ]),

    # --- 短いフレーズ（強い点/弱い点で頻出） ---
    ("なんでもできる", [
        "オールラウンドに活躍できる", "万能にこなせる", "幅広く対応できる",
    ]),
    ("扱いやすく", [
        "使いやすく", "操作しやすく", "取り回しが良く",
    ]),
    ("扱いやすい", [
        "使いやすい", "操作しやすい", "クセがない",
    ]),
    ("噛み合いが良い", [
        "シナジーがある", "相性バッチリ", "かみ合いが抜群",
    ]),
    ("噛み合いが良く", [
        "シナジーがあり", "かみ合いがよく", "連携が良く",
    ]),
    ("溜まりやすい", [
        "チャージが速い", "回転が良い", "ゲージが溜まりやすい",
    ]),
    ("得意ではない", [
        "向いていない", "不得手", "苦手な部類",
    ]),
    ("悩まされる", [
        "困る", "泣かされる", "苦しめられる",
    ]),
    ("当てやすくて", [
        "ヒットさせやすく", "命中させやすく", "当てやすいので",
    ]),
    ("当てやすい", [
        "命中させやすい", "ヒットしやすい", "狙いやすい",
    ]),
    ("塗りが弱く", [
        "塗り性能が低めで", "塗り力が控えめで", "塗りが苦手で",
    ]),
    ("インク効率が良くない", [
        "インクの燃費が悪い", "インク持ちがイマイチ", "インク消費が大きい",
    ]),
    ("ガンガン", [
        "ゴリゴリ", "バリバリ", "ガツガツ",
    ]),
    ("最前線で攻める", [
        "フロントで突っ込む", "前線をゴリ押しする", "ガチの前線で暴れる",
    ]),
    ("対面性能が高い", [
        "タイマンに強い", "1対1が得意", "撃ち合い性能が優秀",
    ]),
    ("塗り性能が", [
        "塗り力が", "塗りの強さが", "ペイント力が",
    ]),
    ("そこそこある", [
        "まあまあある", "それなりにある", "そこそこ優秀",
    ]),
    ("インク管理が難しい", [
        "インクのやりくりが大変", "インク消費の管理が厳しい", "燃費に気を使う必要がある",
    ]),
    ("多くのヘイトを買う", [
        "敵から狙われやすい", "ヘイトを集めやすい", "相手にマークされやすい",
    ]),
    ("汎用性の高い", [
        "使い勝手のいい", "万能な", "どんな場面でも活きる",
    ]),
    ("クイックボムを持つ", [
        "クイックボム持ちである", "クイックボムが使える", "クイボを搭載している",
    ]),
    ("塗りもキルも", [
        "塗り・キルの両方を", "塗りとキルを", "ペイントもキルも",
    ]),
    ("キルを取る", [
        "敵を倒す", "キルを拾う", "相手を落とす",
    ]),
    ("キルが取れる", [
        "敵を倒せる", "キルを拾える", "相手を落とせる",
    ]),
    ("キルが狙いにくい", [
        "倒しにくい", "キルを拾いづらい", "キル力は控えめ",
    ]),
    ("射程が短く", [
        "リーチが短めで", "届く距離が短く", "射程が短めで",
    ]),
    ("ブレが大きい", [
        "弾がバラつく", "集弾性が低い", "ブレが目立つ",
    ]),
    ("扱いが難しい", [
        "使いこなすのが大変", "習得コストが高い", "クセが強い",
    ]),
    ("前衛で戦う武器", [
        "前線で暴れるタイプのブキ", "フロントで活躍する武器", "前に出て戦うブキ",
    ]),

    # --- 7文字以上 ---
    ("非常に強力", [
        "超強力", "とても強い", "かなり優秀",
    ]),
    ("非常に強い", [
        "めちゃ強い", "かなり強力", "超強い",
    ]),
    ("非常に", [
        "かなり", "とても", "めちゃくちゃ", "すごく",
    ]),
    ("強力です", [
        "強い", "パワフルだ", "頼りになる",
    ]),
    ("強力な", [
        "強い", "パワフルな", "頼もしい",
    ]),
    ("重要です", [
        "大切だ", "欠かせない", "キモになる",
    ]),
    ("活躍します", [
        "効果を発揮する", "役に立つ", "力を発揮する",
    ]),
    ("御用達", [
        "必須級", "定番", "マスト",
    ]),
    ("おすすめです", [
        "おすすめだ", "推奨", "イチオシ",
    ]),
    ("おすすめ", [
        "イチオシ", "推奨", "良い選択",
    ]),
    ("特に", [
        "中でも", "とりわけ", "なかでも",
    ]),
    ("基本的に", [
        "原則として", "基本は", "普段は",
    ]),
    ("積みましょう", [
        "装備しよう", "付けよう", "積んでおこう",
    ]),
    ("機動力", [
        "足回り", "移動力", "フットワーク",
    ]),
    ("回転率が高い", [
        "チャージが速い", "溜まるのが早い", "よく溜まる",
    ]),
    ("回転率", [
        "回転", "チャージ速度", "発動ペース",
    ]),
    ("生存力", [
        "生き残り力", "サバイバル力", "生存性",
    ]),
    ("打開力", [
        "巻き返し力", "逆転力", "打開性能",
    ]),
    ("打開", [
        "巻き返し", "逆転", "切り返し",
    ]),
    ("不利な状況", [
        "劣勢", "苦しい展開", "押されている場面",
    ]),
    ("前線で戦う", [
        "最前線に出る", "前に出て戦う", "フロントで戦う",
    ]),
    ("塗りが強い", [
        "塗り性能が高い", "塗り能力が優秀", "塗り力が高い",
    ]),
    ("射程が短い", [
        "リーチが短め", "射程が短め", "届く距離が短い",
    ]),
    ("射程が長い", [
        "リーチが長い", "射程が長め", "遠くまで届く",
    ]),
    ("インク消費", [
        "インクの消費量", "インクの燃費",
    ]),
    ("立ち回り", [
        "動き方", "戦い方", "プレイ",
    ]),
    ("メインの", [
        "メインウェポンの", "メイン射撃の",
    ]),
]

# ═══════════════════════════════════════════════════════════
# 3. 接続詞の置換
# ═══════════════════════════════════════════════════════════
CONNECTOR_MAP = {
    "そのため": ["だから", "なので", "そういうわけで"],
    "しかし": ["ただし", "とはいえ", "一方で"],
    "また": ["さらに", "そのうえ", "加えて", "それに"],
    "そして": ["それから", "加えて"],
    "つまり": ["要するに", "言い換えれば"],
    "ただし": ["ただ", "ただ注意として", "気を付けたいのは"],
}

# ═══════════════════════════════════════════════════════════
# 4. 文末パターンの変換
# ═══════════════════════════════════════════════════════════
ENDING_PATTERNS = [
    (r'について解説した記事です。', [
        'について徹底解説していくよ！',
        'のすべてを詳しく紹介するよ。',
        'を詳しくまとめていくよ。',
    ]),
    (r'について掲載しています。', [
        'についてバッチリまとめたよ。',
        'をしっかり解説しているよ。',
    ]),
    (r'を掲載しています。', [
        'をまとめているよ。',
        'をバッチリ載せているよ。',
    ]),
    (r'が可能です。', ['ができるよ。', 'もできちゃう。']),
    (r'ぜひご覧ください。', ['ぜひチェックしてね。', '参考にしてみてね。']),
    (r'ておきましょう。', ['ておこう。', 'ておくのがベスト。', 'ておくといいよ。']),
    (r'に注意しましょう。', ['に注意しよう。', 'には気を付けよう。']),
    (r'を意識しましょう。', ['を意識しよう。', 'を心がけよう。']),
    (r'ていきましょう。', ['ていこう。', 'ていくといいよ。']),
    (r'を使いましょう。', ['を使おう。', 'を活用しよう。']),
    (r'にしましょう。', ['にしよう。', 'にするのがベスト。']),
    (r'てみましょう。', ['てみよう。', 'てみるといいよ。']),
    (r'をしましょう。', ['をしよう。', 'をやっておこう。']),
    (r'しましょう。', ['しよう。', 'するのがおすすめ。', 'するといいよ。']),
    (r'することができます。', ['できる。', 'できちゃう。']),
    (r'ことができます。', ['ことも可能だ。', 'こともできる。']),
    (r'があります。', ['がある。', 'があるよ。']),
    (r'ではありません。', ['じゃない。', 'ではない。']),
    (r'ありません。', ['ない。', 'ないよ。']),
    (r'となっています。', ['になっている。', 'だ。']),
    (r'(しい|かい|ない|たい|よい|すい|るい|らい|きい|がい|ぶい|くい|どい|わい|ひい|にい)です。',
     [r'\1よ。', r'\1んだ。', r'\1。']),
    (r'です。', ['だ。', 'だよ。', 'なんだ。']),
    (r'れます。', ['れる。', 'れるよ。']),
    (r'います。', ['いる。', 'いるよ。']),
    (r'できます。', ['できる。', 'できるよ。']),
    (r'なります。', ['なる。', 'なるよ。']),
    (r'ません。', ['ない。', 'ないよ。']),
    (r'てください。', ['てね。', 'てみてね。']),
    (r'ください。', ['ね。', 'てね。']),
]

# ═══════════════════════════════════════════════════════════
# 5. 文の構造変換パターン
# ═══════════════════════════════════════════════════════════
STRUCTURE_TRANSFORMS = [
    # 「AのためB」→「B。AだからだA」
    (r'(.{5,30})ため、(.{5,30})', [
        r'\2。\1からだ',
        r'\2。理由は\1から',
    ]),
    # 「Aが強みです」→「強みはA」
    (r'(.{3,20})が強みです', [
        r'強みは\1というところ',
        r'\1のが魅力的',
    ]),
    # 「〜する必要があります」
    (r'する必要があります', [
        'しないといけない', 'しなきゃダメ', 'する必要がある',
    ]),
    # 「〜のが良いでしょう」
    (r'のが良いでしょう', ['のがベスト', 'のがおすすめ', 'のが正解']),
]


# ═══════════════════════════════════════════════════════════
# メイン処理関数
# ═══════════════════════════════════════════════════════════

def rewrite_paragraph(text, weapon_name, paragraph_idx=0):
    """パラグラフ全体を本格リライト"""
    if not text or not text.strip():
        return text

    original = text

    # Phase 1: 定型文のファジーマッチ置換
    text = _apply_stock_phrases(text, weapon_name, paragraph_idx)

    # Phase 2: フレーズ単位の置換（長い順に適用）
    text = _apply_phrase_replacements(text, weapon_name, paragraph_idx)

    # Phase 3: 文に分割して各文を処理
    sentences = re.split(r'(?<=。)', text)
    rewritten = []
    for i, sent in enumerate(sentences):
        if not sent.strip():
            continue
        ctx = f"p{paragraph_idx}_s{i}"
        sent = _apply_connectors(sent, weapon_name, ctx)
        sent = _apply_structure_transforms(sent, weapon_name, ctx)
        sent = _apply_endings(sent, weapon_name, ctx)
        rewritten.append(sent)

    return "".join(rewritten)


def rewrite_short_phrase(text, weapon_name, phrase_idx=0):
    """短いフレーズ（強い点/弱い点など）のリライト"""
    if not text or not text.strip():
        return text

    ctx = f"short_{phrase_idx}"

    # Phase 1: 定型文チェック
    text = _apply_stock_phrases(text, weapon_name, phrase_idx)

    # Phase 2: フレーズ置換
    text = _apply_phrase_replacements(text, weapon_name, phrase_idx)

    # Phase 3: 文末変換
    text = _apply_endings(text, weapon_name, ctx)

    return text


# ─── 内部関数 ─────────────────────────────────────

def _apply_stock_phrases(text, weapon_name, idx):
    """定型文をファジーマッチで置換"""
    for entry in STOCK_PHRASES:
        for pattern in entry["patterns"]:
            # 正規表現パターンとして試行
            try:
                if re.search(pattern, text):
                    replacement = _pick(entry["replacements"], weapon_name, f"stock_{idx}_{pattern[:15]}")
                    text = re.sub(pattern, replacement, text, count=1)
                    break  # 1エントリにつき1回マッチしたら次へ
            except re.error:
                # 正規表現エラーの場合は通常の文字列マッチ
                if pattern in text:
                    replacement = _pick(entry["replacements"], weapon_name, f"stock_{idx}_{pattern[:15]}")
                    text = text.replace(pattern, replacement, 1)
                    break
    return text


def _apply_phrase_replacements(text, weapon_name, idx):
    """フレーズ単位の置換（長い順）"""
    # PHRASE_REPLACEMENTS はすでに長い順にソートされている
    for original_phrase, alternatives in PHRASE_REPLACEMENTS:
        if original_phrase in text:
            replacement = _pick(alternatives, weapon_name, f"phrase_{idx}_{original_phrase[:8]}")
            text = text.replace(original_phrase, replacement, 1)
    return text


def _apply_connectors(text, weapon_name, ctx):
    """接続詞を置換"""
    for original, alternatives in CONNECTOR_MAP.items():
        # 文頭の接続詞
        if text.startswith(original):
            replacement = _pick(alternatives, weapon_name, f"conn_{ctx}_{original}")
            text = replacement + text[len(original):]
        # 句点の後の接続詞
        pattern = "。" + original
        if pattern in text:
            replacement = _pick(alternatives, weapon_name, f"conn2_{ctx}_{original}")
            text = text.replace(pattern, "。" + replacement, 1)
    return text


def _apply_structure_transforms(text, weapon_name, ctx):
    """文の構造を変換"""
    seed = _hash_seed(weapon_name, f"struct_{ctx}")
    # 構造変換は50%の確率で適用（やりすぎ防止）
    if seed % 2 == 0:
        for pattern, alternatives in STRUCTURE_TRANSFORMS:
            if re.search(pattern, text):
                replacement = _pick(alternatives, weapon_name, f"struct_{ctx}_{pattern[:10]}")
                try:
                    text = re.sub(pattern, replacement, text, count=1)
                except re.error:
                    pass
                break  # 1文に1変換まで
    return text


def _apply_endings(text, weapon_name, ctx):
    """文末表現を変換"""
    for pattern, alternatives in ENDING_PATTERNS:
        if re.search(pattern, text):
            replacement = _pick(alternatives, weapon_name, f"end_{ctx}_{pattern[:10]}")
            text = re.sub(pattern, replacement, text, count=1)
            break  # 1回のみ
    return text
